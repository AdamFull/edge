set(STB_DIR "${CMAKE_CURRENT_SOURCE_DIR}")
set(STB_IMPL_DIR "${CMAKE_CURRENT_BINARY_DIR}/stb_impl")
set(STB_CONFIG_HEADER "${STB_IMPL_DIR}/stb_config.h")

file(MAKE_DIRECTORY "${STB_IMPL_DIR}")

set(STB_USE_MIMALLOC OFF)
if(TARGET mimalloc-static OR TARGET mimalloc)
    set(STB_USE_MIMALLOC ON)
    message(STATUS "STB: mimalloc found, will use custom allocator")
else()
    message(STATUS "STB: mimalloc not found, using default allocator")
endif()

file(WRITE "${STB_CONFIG_HEADER}"
"#ifndef STB_CONFIG_H\n"
"#define STB_CONFIG_H\n"
"\n"
"/* STB Library Configuration */\n"
"/* Generated by CMake - do not edit manually */\n"
"\n"
)

if(STB_USE_MIMALLOC)
    file(APPEND "${STB_CONFIG_HEADER}"
"#define STB_USE_MIMALLOC 1\n"
"#include <mimalloc.h>\n"
"\n"
"/* Custom allocator macros for stb_image */\n"
"#define STBI_MALLOC(sz)           mi_malloc(sz)\n"
"#define STBI_REALLOC(p, newsz)    mi_realloc(p, newsz)\n"
"#define STBI_FREE(p)              mi_free(p)\n"
"\n"
"/* Custom allocator macros for stb_image_resize2 */\n"
"#define STBIR_MALLOC(sz, ctx)     mi_malloc(sz)\n"
"#define STBIR_FREE(p, ctx)        mi_free(p)\n"
"\n"
"/* Custom allocator macros for stb_image_write */\n"
"#define STBIW_MALLOC(sz)          mi_malloc(sz)\n"
"#define STBIW_REALLOC(p, newsz)   mi_realloc(p, newsz)\n"
"#define STBIW_FREE(p)             mi_free(p)\n"
"\n"
)
else()
    file(APPEND "${STB_CONFIG_HEADER}"
"#define STB_USE_MIMALLOC 0\n"
"/* Using default system allocator */\n"
"\n"
)
endif()

file(APPEND "${STB_CONFIG_HEADER}"
"#endif /* STB_CONFIG_H */\n"
)

set(STB_IMAGE_IMPL_C "${STB_IMPL_DIR}/stb_image.c")
file(WRITE "${STB_IMAGE_IMPL_C}"
"/* stb_image implementation file */\n"
"#include \"stb_config.h\"\n"
"\n"
"#ifndef STB_IMAGE_IMPLEMENTATION\n"
"#define STB_IMAGE_IMPLEMENTATION\n"
"#include \"stb_image.h\"\n"
"#endif\n"
)

set(STB_IMAGE_RESIZE2_IMPL_C "${STB_IMPL_DIR}/stb_image_resize2.c")
file(WRITE "${STB_IMAGE_RESIZE2_IMPL_C}"
"/* stb_image_resize2 implementation file */\n"
"#include \"stb_config.h\"\n"
"\n"
"#ifndef STB_IMAGE_RESIZE_IMPLEMENTATION\n"
"#define STB_IMAGE_RESIZE_IMPLEMENTATION\n"
"#include \"stb_image_resize2.h\"\n"
"#endif\n"
)

set(STB_IMAGE_WRITE_IMPL_C "${STB_IMPL_DIR}/stb_image_write.c")
file(WRITE "${STB_IMAGE_WRITE_IMPL_C}"
"/* stb_image_write implementation file */\n"
"#include \"stb_config.h\"\n"
"\n"
"#ifndef STB_IMAGE_WRITE_IMPLEMENTATION\n"
"#define STB_IMAGE_WRITE_IMPLEMENTATION\n"
"#include \"stb_image_write.h\"\n"
"#endif\n"
)

set(STB_DXT_IMPL_C "${STB_IMPL_DIR}/stb_dxt.c")
file(WRITE "${STB_DXT_IMPL_C}"
"/* stb_dxt implementation file */\n"
"#ifndef STB_DXT_IMPLEMENTATION\n"
"#define STB_DXT_IMPLEMENTATION\n"
"#include \"stb_dxt.h\"\n"
"#endif\n"
)

add_library(stb STATIC
    ${STB_IMAGE_IMPL_C}
    ${STB_IMAGE_RESIZE2_IMPL_C}
    ${STB_IMAGE_WRITE_IMPL_C}
    ${STB_DXT_IMPL_C}
)

target_compile_features(stb PRIVATE c_std_11)

target_include_directories(stb 
    PUBLIC 
        ${STB_DIR}
    PRIVATE
        ${STB_IMPL_DIR}
)

if(STB_USE_MIMALLOC)
    if(TARGET mimalloc-static)
        target_link_libraries(stb PRIVATE mimalloc-static)
    elseif(TARGET mimalloc)
        target_link_libraries(stb PRIVATE mimalloc)
    endif()
endif()